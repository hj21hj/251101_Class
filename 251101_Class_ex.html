<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>조계종 공지사항 통합 (두 게시판) + EN 토글</title>
<style>
  :root { color-scheme: light dark; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; background:#f7f7f8; color:#111; }
  header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb; }
  .wrap { max-width:1100px; margin:0 auto; padding:16px; }
  h1 { margin:0 0 8px; font-size:20px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .spacer { flex:1; }
  .btn { padding:10px 14px; border:1px solid #e5e7eb; background:#fff; border-radius:10px; cursor:pointer; }
  .btn:hover { background:#fafafa; }
  .btn.active { background:#111; color:#fff; border-color:#111; }
  input[type="search"]{ padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; min-width:260px; }
  #status { display:none; margin-top:8px; padding:10px 12px; border-radius:10px; border:1px solid #dbeafe; background:#eff6ff; color:#1d4ed8; font-size:14px; }

  main { padding:20px 0 40px; }
  ul.titles { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }
  li.item { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .badge { font-size:12px; color:#ef4444; font-weight:800; white-space:nowrap; }
  .src { font-size:12px; color:#4f46e5; font-weight:700; white-space:nowrap; margin-left:6px; }
  a.link { font-size:15px; font-weight:700; color:#0f172a; text-decoration:none; line-height:1.35; }
  a.link:hover { text-decoration:underline; overflow-wrap:anywhere; }

  .skeleton { height:42px; border-radius:12px; border:1px solid #eee;
    background:linear-gradient(90deg,#eee 25%,#f7f7f7 37%,#eee 63%); background-size:400% 100%; animation:shimmer 1.3s infinite; }
  @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:0 0} }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>조계종 공지사항 통합</h1>
      <div class="row">
        <input id="search" type="search" placeholder="공지 제목 검색…" />
        <button id="clear" class="btn">지우기</button>
        <div class="spacer"></div>
        <a href="https://www.buddhism.or.kr/board/list.php?tn=news_01_02" target="_blank" rel="noopener"><button class="btn">소식 원문</button></a>
        <a href="https://www.buddhism.or.kr/board/list.php?tn=pogyo_01_0101" target="_blank" rel="noopener"><button class="btn">포교활동 원문</button></a>
        <button id="btnKR" class="btn active" title="원문(한국어)">KR</button>
        <button id="btnEN" class="btn" title="영문 번역">EN</button>
      </div>
      <div id="status"></div>
    </div>
  </header>

  <main class="wrap">
    <ul id="list" class="titles">
      <li class="skeleton"></li>
      <li class="skeleton"></li>
      <li class="skeleton"></li>
    </ul>
  </main>

<script>
/* ====== 대상 게시판 (목록 페이지) ====== */
const SOURCES = [
  {
    name: "조계종 소식",
    origin: "https://www.buddhism.or.kr/board/list.php?tn=news_01_02",
    md:     "https://r.jina.ai/https://www.buddhism.or.kr/board/list.php?tn=news_01_02"
  },
  {
    name: "포교활동",
    origin: "https://www.buddhism.or.kr/board/list.php?tn=pogyo_01_0101",
    md:     "https://r.jina.ai/https://www.buddhism.or.kr/board/list.php?tn=pogyo_01_0101"
  }
];

/* ====== 상태/DOM ====== */
const state = {
  items: [],        // {src, title, titleEN?, url}
  filtered: null,
  lang: "kr",       // 'kr' | 'en'
  tCache: new Map() // title KR -> title EN
};
const $list   = document.getElementById("list");
const $search = document.getElementById("search");
const $clear  = document.getElementById("clear");
const $status = document.getElementById("status");
const $btnKR  = document.getElementById("btnKR");
const $btnEN  = document.getElementById("btnEN");

/* ====== UI 유틸 ====== */
function setStatus(msg, tone="info") {
  $status.style.display = "block";
  $status.style.color = tone==="warn" ? "#92400e" : "#1d4ed8";
  $status.style.borderColor = tone==="warn" ? "#fcd34d" : "#dbeafe";
  $status.style.background = tone==="warn" ? "#fffbeb" : "#eff6ff";
  $status.textContent = msg;
}
function hideStatus(){ $status.style.display="none"; }

function liHTML(it){
  const text = state.lang === "en" ? (it.titleEN || it.title) : it.title;
  return `<li class="item">
    <span class="badge">공지</span><span class="src">${it.src}</span>
    <a class="link" href="${it.url}" target="_blank" rel="noopener">${text}</a>
  </li>`;
}
function render(list){
  $list.innerHTML = "";
  for (const it of list) $list.insertAdjacentHTML("beforeend", liHTML(it));
}

/* ====== 공지 필터 규칙 (Markdown 문맥 기반) ====== */
const NOTICE_REGEX = /(공지사항|공지|[\[\(]공지[\]\)]|rb-noti)/i;

/* ====== Markdown에서 공지 제목만 추출 ====== */
function extractNoticeTitlesFromMarkdown(mdText, srcName, baseUrl){
  const out = [];
  const lines = mdText.split(/\r?\n/);
  const linkRe = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;

  for (let i = 0; i < lines.length; i++){
    const line = lines[i];
    let m;
    while ((m = linkRe.exec(line)) !== null) {
      const title = (m[1] || "").trim();
      let href = (m[2] || "").trim();
      if (!title || !href) continue;
      if (!/^https?:\/\//i.test(href)) {
        try { href = new URL(href, baseUrl).href; } catch(e){}
      }
      const context = [
        lines[i-2] || "", lines[i-1] || "",
        line,
        lines[i+1] || "", lines[i+2] || ""
      ].join(" \n ");
      if (NOTICE_REGEX.test(context)) {
        out.push({ src: srcName, title, url: href });
      }
    }
  }
  // 중복 제거
  const seen = new Set();
  return out.filter(it=>{
    const key = it.src + "||" + it.title + "||" + it.url;
    if (seen.has(key)) return false;
    seen.add(key); return true;
  });
}

/* ====== 로드 ====== */
async function load(){
  try{
    const all = [];
    for (const s of SOURCES){
      const res = await fetch(s.md);
      if (!res.ok) throw new Error("목록 응답 실패");
      const md = await res.text();
      all.push(...extractNoticeTitlesFromMarkdown(md, s.name, s.origin));
    }

    if (!all.length){
      setStatus("공지사항만 필터링했으나 결과가 없습니다. (목록 변환 형태가 달라졌을 수 있어요)", "warn");
      $list.innerHTML = "";
      return;
    }

    // 정렬: 출처 → 제목 가나다
    all.sort((a,b)=>{
      if (a.src !== b.src) return a.src.localeCompare(b.src, "ko");
      return a.title.localeCompare(b.title, "ko");
    });

    state.items = all;
    state.filtered = null;
    hideStatus();
    render(all);
  }catch(e){
    console.error(e);
    setStatus("네트워크/보안정책으로 공지 목록을 불러오지 못했습니다.", "warn");
    $list.innerHTML = "";
  }
}

/* ====== 번역: 제목만 EN으로 (비공식 Google Translate) ====== */
async function translateTitlesToEN(items){
  const needs = items
    .map(it => it.title)
    .filter(t => t && !state.tCache.has(t));

  for (const q of needs){
    const url = "https://r.jina.ai/http://translate.googleapis.com/translate_a/single"
      + "?client=gtx&sl=auto&tl=en&dt=t&q=" + encodeURIComponent(q);
    try{
      const r = await fetch(url);
      if (!r.ok) throw new Error("translate blocked");
      const txt = await r.text();
      const arr = JSON.parse(txt);
      const translated = (arr && arr[0] && arr[0].map(seg=>seg[0]).join("")) || q;
      state.tCache.set(q, translated);
    }catch(err){
      // 실패해도 원문을 캐시에 넣어 중복 호출 방지
      state.tCache.set(q, q);
    }
  }
  // 매핑
  for (const it of items){
    it.titleEN = state.tCache.get(it.title) || it.title;
  }
}

/* ====== 검색 (표시 언어 기준) ====== */
function currentListForSearch(){
  const src = state.filtered ?? state.items;
  if (state.lang === "en") {
    return src.map(it => ({...it, _searchText: (it.titleEN || it.title).toLowerCase()}));
  } else {
    return src.map(it => ({...it, _searchText: it.title.toLowerCase()}));
  }
}
function applySearch(q){
  const query = q.trim().toLowerCase();
  if (!query) {
    state.filtered = null;
    render(state.items);
    return;
  }
  const pool = state.items.map(it => ({
    it,
    text: state.lang==="en" ? (it.titleEN || it.title).toLowerCase() : it.title.toLowerCase()
  }));
  state.filtered = pool.filter(p => p.text.includes(query)).map(p => p.it);
  render(state.filtered);
}

/* ====== 이벤트 ====== */
document.getElementById("clear").addEventListener("click", ()=>{
  $search.value = ""; applySearch("");
});
$search.addEventListener("input", e => applySearch(e.target.value));

$btnKR.addEventListener("click", ()=>{
  if (state.lang === "kr") return;
  state.lang = "kr";
  $btnKR.classList.add("active");
  $btnEN.classList.remove("active");
  render(state.filtered ?? state.items);
});

$btnEN.addEventListener("click", async ()=>{
  if (state.lang === "en") return;
  setStatus("공지 제목을 영어로 번역 중…");
  try{
    // items와 filtered 모두 EN 필드를 확보
    await translateTitlesToEN(state.items);
    if (state.filtered) await translateTitlesToEN(state.filtered);
    state.lang = "en";
    $btnEN.classList.add("active");
    $btnKR.classList.remove("active");
    render(state.filtered ?? state.items);
    hideStatus();
  }catch(e){
    console.error(e);
    setStatus("번역 서비스에 접속할 수 없어 원문으로 표시합니다.", "warn");
  }
});

/* ====== 시작 ====== */
load();
</script>
</body>
</html>
